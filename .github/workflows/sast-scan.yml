name: Security SAST scan (Detect vulnerabilities)

on:
  pull_request:
    branches:
      - master
      - develop
      - preprods

jobs:
  semgrep:
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: read
      security-events: write
      actions: read

    steps:

      - name: ğŸ§ª List files 1
        run: Get-ChildItem -Force

      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install semgrep and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep --version
      
      - name: ğŸ§ª List files 2
        run: Get-ChildItem -Force

      - name: ğŸš€ ExÃ©cution de Semgrep et gÃ©nÃ©ration du rapport SARIF
        run: |
          semgrep --config auto --sarif --output semgrep-report.sarif .
          $semgrepReport = Get-Content semgrep-report.sarif -Raw | ConvertFrom-Json
          $VULN_COUNT = $semgrepReport.runs[0].results.Count
          Write-Host "Nombre de vulnÃ©rabilitÃ©s dÃ©tectÃ©es : $VULN_COUNT"
          "VULN_COUNT=$VULN_COUNT" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: ğŸ§ª List files 3
        run: Get-ChildItem -Force

      - name: â¬†ï¸ Upload Semgrep file as SARIF to GitHub Advanced Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-report.sarif
          category: semgrep-sast-analysis

      - name: âœ… VÃ©rification du rÃ©sultat de lâ€™analyse
        run: |
          if ($env:VULN_COUNT -gt 0) {
            Write-Host "âŒ $env:VULN_COUNT vulnÃ©rabilitÃ©s dÃ©tectÃ©es. CI bloquÃ©e."
            exit 1
          } else {
            Write-Host "âœ… Aucune vulnÃ©rabilitÃ© dÃ©tectÃ©e. CI validÃ©e."
          }
